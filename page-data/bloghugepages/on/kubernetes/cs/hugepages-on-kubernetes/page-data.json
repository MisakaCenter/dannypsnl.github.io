{"componentChunkName":"component---src-templates-blog-post-js","path":"/bloghugepages/on/kubernetes//cs/hugepages-on-kubernetes/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://dannypsnl.github.io"}},"markdownRemark":{"html":"<h2>What is Huge Page?</h2>\n<p>When a process using some memory, CPU marking the RAM used by the process. For efficiently, CPU allocate by chunks by 4K bytes(default on many platforms). Those chunks called pages. Since process address space is virtual, CPU and OS must remember which page belongs to which process, more memory been used, more pages need to be managed. To avoid heavy scheduling about pages, most current CPU architectures support the bigger page than 4KB, on Linux, it named huge page.</p>\n<h2>Kubernetes</h2>\n<p>We are in the containerization world now, kubernetes is an open-source container orchestration system for automating deployment, scaling, and management. But some application requiring the huge page ability, in our case, that's DPDK.</p>\n<h2>So can we use enable hugepages in kubernetes?</h2>\n<p>The answer is yes, but we have to check the version of kubernetes first.</p>\n<p>According to <a href=\"https://kubernetes.io/docs/reference/command-line-tools-reference/feature-gates/\">feature-gates</a> description. If your kubernetes version >= 1.10, then HugePages default on, else you have to enable it by yourself.</p>\n<p>Log in to your kubernetes node machine. Open and edit <code class=\"language-text\">/etc/default/kubelet</code> this file, find <code class=\"language-text\">-—feature-gates=</code> these texts, add some text to make it looks like <code class=\"language-text\">-—feature-gates=HugePages=true</code>.</p>\n<blockquote>\n<p>p.s. If you want to add more than one feature, use <code class=\"language-text\">,</code> separate the option, e.g. <code class=\"language-text\">--feature-gates=&quot;...,DynamicKubeletConfig=true&quot;</code></p>\n</blockquote>\n<p>Save and close editor, now run the following commands:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># according to your environment, this is optional</span>\n$ systemctl daemon-reload\n$ systemctl restart kubelet</code></pre></div>\n<blockquote>\n<p>p.s. You might need <code class=\"language-text\">sudo</code> before the command, also according to your environment</p>\n</blockquote>\n<blockquote>\n<p>p.s. <a href=\"https://kubernetes.io/docs/setup/independent/kubelet-integration/\">advanced kubelet config</a></p>\n</blockquote>\n<p>The previous setting is for kubernetes 1.8 and 1.9, 1.7 and below do not support this feature.</p>\n<p>Now lets into the next section, how to mount huge page on to node.</p>\n<p>Commands are easy:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">mkdir</span> -p /mnt/huge\n$ <span class=\"token function\">mount</span> -t hugetlbfs nodev /mnt/huge\n<span class=\"token comment\"># 1024 is the total number of hugepages, you can using others value as you need</span>\n$ <span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1024</span> <span class=\"token operator\">></span> /sys/devices/system/node/node0/hugepages/hugepages-2048kB/nr_hugepages</code></pre></div>\n<blockquote>\n<p>p.s. As the previous note, you might need <code class=\"language-text\">sudo</code> to do those stuff, and read <a href=\"https://stackoverflow.com/questions/84882/sudo-echo-something-etc-privilegedfile-doesnt-work\">this</a> to know by sudo echo might not work as what you think</p>\n</blockquote>\n<p>Then use: <code class=\"language-text\">cat /proc/meminfo | grep Huge</code> to see current status, after these, <code class=\"language-text\">systemctl restart kubelet</code> again.</p>\n<p>Now leave your node machine, and use: <code class=\"language-text\">kubectl describe nodes</code> to check hugepages is enable or not. You might see something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Node\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> node1\n<span class=\"token comment\"># ignore...</span>\n<span class=\"token key atrule\">status</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 10Gi\n    <span class=\"token key atrule\">hugepages-2Mi</span><span class=\"token punctuation\">:</span> 1Gi\n  <span class=\"token key atrule\">allocatable</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> 9Gi\n    <span class=\"token key atrule\">hugepages-2Mi</span><span class=\"token punctuation\">:</span> 1Gi\n<span class=\"token comment\"># ignore...</span></code></pre></div>\n<p>An example pod:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Pod\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> example\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># use the image you like</span>\n    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /hugepages\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> hugepage\n    <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">hugepages-2Mi</span><span class=\"token punctuation\">:</span> 1Gi\n      <span class=\"token key atrule\">limits</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">hugepages-2Mi</span><span class=\"token punctuation\">:</span> 1Gi\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> hugepage\n      <span class=\"token key atrule\">emptyDir</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">medium</span><span class=\"token punctuation\">:</span> HugePages</code></pre></div>\n<h3>Could we setting hugepages in Pod?</h3>\n<p>For now, this feature seems won't support to use Pod configure hugepages, according to the <a href=\"https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/hugepages.md#scope\">proposal</a> description.</p>\n<p>After researching, we finally run up our Router with DPDK(although have other issues) in Pod, and we found we might not be able to mount hugepages at Pod init time.</p>\n<h2>Conculsion</h2>\n<p>After learning about how to enable the hugepages, you might not have the chance to use hugepages directly, but a lot of third-party software would use it, then you can get the benefit from the hugepages. Thanks for the reading.</p>","frontmatter":{"title":"HugePages on Kubernetes","categories":["cs"],"tags":["workrecord","hugepages","kubernetes","linux"]}}},"pageContext":{"slug":"/bloghugepages/on/kubernetes//cs/hugepages-on-kubernetes/"}}}