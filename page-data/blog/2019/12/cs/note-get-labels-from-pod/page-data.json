{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/2019/12/cs/note-get-labels-from-pod/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://dannypsnl.github.io"}},"markdownRemark":{"html":"<p>This week our company wants to improve one of our projects which is based on Istio, exchanging weight in different checker instances, make the traffic distribution fairer. My co-worker provides a nice idea: We watching Pods by the <a href=\"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/\">label selector</a> to discover others instance. Code looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\">watcher<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">CoreV1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Pods</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"istio-system\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Watch</span><span class=\"token punctuation\">(</span>meta<span class=\"token punctuation\">.</span>ListOptions<span class=\"token punctuation\">{</span>\n\tWatch<span class=\"token punctuation\">:</span>         <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n\tLabelSelector<span class=\"token punctuation\">:</span> <span class=\"token string\">\"xxx=yyy\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But this causes a problem, you can see that string <code class=\"language-text\">&quot;xxx=yyy&quot;</code>, we have no graceful way to avoid the repeating of label selector in Kubernetes config(for Kubernetes) and environment variable(for our program). And one day they would outdated.</p>\n<p>In the beginning, we have a discussion and thought that it would unlikely to have the access to label selector value in Pod. Then start searching in the document. You know what? Surprisingly we can! Even have a few ways can choose! Let's take a look at them:</p>\n<ol>\n<li>\n<p>Use <code class=\"language-text\">env</code> variables</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels<span class=\"token punctuation\">-</span>container\n<span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n       <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels<span class=\"token punctuation\">-</span>container\n   <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n       <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> a<span class=\"token punctuation\">-</span>container\n       <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">:</span><span class=\"token number\">18.04</span>\n       <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n           <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> SELECTOR_VALUE\n           <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">fieldRef</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">fieldPath</span><span class=\"token punctuation\">:</span> metadata.labels<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>In this case, we can get one value from a label selector pair.</p>\n</li>\n<li>\n<p>Load them into a file</p>\n<p>This requires a new API called: <code class=\"language-text\">downwardAPI</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apps/v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Deployment\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels<span class=\"token punctuation\">-</span>container\n<span class=\"token key atrule\">template</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n       <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> get<span class=\"token punctuation\">-</span>labels<span class=\"token punctuation\">-</span>container\n   <span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">containers</span><span class=\"token punctuation\">:</span>\n       <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> a<span class=\"token punctuation\">-</span>container\n       <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">:</span><span class=\"token number\">18.04</span>\n       <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n           <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> podinfo\n           <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /etc/podinfo\n       <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n           <span class=\"token punctuation\">-</span> sleep\n           <span class=\"token punctuation\">-</span> inf\n   <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n       <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> podinfo\n       <span class=\"token key atrule\">downwardAPI</span><span class=\"token punctuation\">:</span>\n           <span class=\"token key atrule\">items</span><span class=\"token punctuation\">:</span>\n           <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"labels\"</span>\n               <span class=\"token key atrule\">fieldRef</span><span class=\"token punctuation\">:</span>\n               <span class=\"token key atrule\">fieldPath</span><span class=\"token punctuation\">:</span> metadata.labels</code></pre></div>\n<p>In this container, we can use <code class=\"language-text\">cat /etc/podinfo/labels</code> to get all label selectors. So if we want to get all of them then we can use this solution.</p>\n</li>\n</ol>\n<p>Now, hope this can save your time since it's in a weird place of Kubernetes document. And thanks for your read.</p>\n<h4>References</h4>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/\">k8s Doc: Expose Pod Information to Containers Through Files</a></li>\n</ul>","frontmatter":{"title":"NOTE: get labels from Pod","categories":["cs"],"tags":["note","kubernetes"]}}},"pageContext":{"slug":"/blog/2019/12/cs/note-get-labels-from-pod/"}}}