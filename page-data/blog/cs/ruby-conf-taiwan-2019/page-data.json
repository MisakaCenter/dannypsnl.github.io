{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/cs/ruby-conf-taiwan-2019/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://dannypsnl.github.io"}},"markdownRemark":{"html":"<h3>Get start</h3>\n<p>This article is the note and thought I get from the conference.</p>\n<p>I would mention the following topics:</p>\n<ul>\n<li>type checker for Ruby(steep)</li>\n<li>GC compaction</li>\n</ul>\n<h3>type checking for Ruby</h3>\n<h4>Ruby 3</h4>\n<p>Basically, I understand what Matz(creator of Ruby) want is a type inferer generate a type definition file, then we can modify it to be more accurate. Finally, the checker check program based on the file modified by you. So that we can avoid typing any extra information but still have a static type analyzer.</p>\n<p>Few questions I have are:</p>\n<ul>\n<li>what if I regenerate the type definition file after I modified it? - seems like would be replaced right now</li>\n<li>\n<p>how it avoids Hindley Milner type system limit?</p>\n<p>  \tFor example, a mutable cell holding a list of values of unspecified type.\np.s. What we can do is <a href=\"http://users.cs.fiu.edu/~smithg/cop4555/valrestr.html\">value restriction</a> here. Anyway, we need some extension for the type system.</p>\n</li>\n</ul>\n<h4><a href=\"https://github.com/soutaro/steep\">steep</a></h4>\n<p><a href=\"https://youtu.be/KU1JM4NSKe8\">Video</a></p>\n<p>Then we keep going since I have more talk with Steep creator(Soutaro Matsumoto) XD.</p>\n<p>Not going to talk about too many type inference here but I would talk a little bit for the question from Soutaro Matsumoto.</p>\n<p>The problem he has is:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n  <span class=\"token keyword\">def</span> `<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>`<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># for arr[1] = T.new</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token comment\"># for arr[0, 1] = T.new</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token comment\"># for arr[0, 1] = [T.new]</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n    <span class=\"token comment\"># for arr[0..1] = T.new</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token comment\"># for arr[0..1] = [T.new]</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>Now we have a wrong typed example:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token comment\"># Array&lt;Integer></span>\narr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"foo\"</span></code></pre></div>\n<p>From human view, we expect an error like <code class=\"language-text\">expected: Integer but got: String</code>.\nHowever, for overloading, we have to try other methods since we can't sure it would match or not. So the checker keeps going on, and failed at the final definition and report <code class=\"language-text\">expected: Array&lt;Integer&gt; but got: String</code> which is a little bit confusing.</p>\n<p>Let's consider more general overloading, at here general means semantic is less limited if the overloading is a normal method than an operator.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class C&lt;T&gt;\n  def foo:\n    (Integer, T) -&gt; T\n    | (Integer, Integer, T) -&gt; T\nend</code></pre></div>\n<p>I think, in this case, we can't do more than say can't find a method for blablabla. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">c <span class=\"token operator\">=</span> <span class=\"token constant\">C</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">String</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token keyword\">new</span>\nc<span class=\"token punctuation\">.</span>foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>We have no idea user is trying to match <code class=\"language-text\">(Integer, Integer, T) -&gt; T</code> by missing one argument, or trying to type <code class=\"language-text\">c.foo(1, &quot;2&quot;)</code> but wrong.</p>\n<p>However, in my understanding, we can't add more operators into Ruby by the problem.</p>\n<p>So operators actucally are different than normal methods. For example:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\narr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\narr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">9</span></code></pre></div>\n<p>If <code class=\"language-text\">arr[0, 2] =</code> didn't follow a right hand side expression, it actually represents the same type as <code class=\"language-text\">arr[0] = 2</code> which is obviously wrong. So we can depend on this extra semantic and redefine the type of <code class=\"language-text\">[]=</code> operator to:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n  <span class=\"token keyword\">def</span> `<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>`<span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>But since we actually don't want the assign missing the right-hand side so we have to have another special notation for this special function, so it could be:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n  <span class=\"token keyword\">def</span> `<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>`<span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">(</span><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p><code class=\"language-text\">=&gt;</code> cuts semantic steps. <code class=\"language-text\">-&gt;</code> followed by the finally return type.</p>\n<p>Which represents:</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n  <span class=\"token keyword\">def</span> `<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>`<span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">[</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">T</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">T</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">Integer</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token constant\">T</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token constant\">T</span>\n    <span class=\"token operator\">|</span> <span class=\"token punctuation\">[</span><span class=\"token builtin\">Range</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">Integer</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<p>p.s. After I mention the idea with Soutaro Matsumoto, he points out the new syntax might not a good idea, that also make sense in the context. Since break current program won't be anyone wants. But in type checker can use the abstraction to do better inference.</p>\n<h3>GC compaction</h3>\n<p><a href=\"https://youtu.be/0ypPiULlKfQ\">Video</a></p>\n<p>Why we need compaction? Without compaction, we can have out of memory due to the fragmented heap. What is a fragmented heap?</p>\n<p>This is:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUCAwT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAABsngItoLA/8QAGhABAQACAwAAAAAAAAAAAAAAAQIAAxMhMv/aAAgBAQABBQKdvc75qjYOX5F5Ckf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQMBAT8BTGf/xAAWEQADAAAAAAAAAAAAAAAAAAAAARH/2gAIAQIBAT8BTpD/xAAeEAACAQMFAAAAAAAAAAAAAAAAAQIDESESIkFRcf/aAAgBAQAGPwK6XhLVg2iKa7ZLPJ//xAAaEAADAQEBAQAAAAAAAAAAAAAAAREhMUFR/9oACAEBAAE/IV3Z6FonConu1waQ9ZumaL6LhNLP/9oADAMBAAIAAwAAABCjz//EABcRAAMBAAAAAAAAAAAAAAAAAAABEUH/2gAIAQMBAT8QVAqWH//EABcRAQEBAQAAAAAAAAAAAAAAAAEAEUH/2gAIAQIBAT8QYWnt/8QAGxABAQADAAMAAAAAAAAAAAAAAREAIUExUfH/2gAIAQEAAT8Qm6qrsbE2eOuUN206n3AQJ7KJH1jawiMOYAkS8BZvCnAAZ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dirty room\"\n        title=\"dirty room\"\n        src=\"/static/2cc395ed05f89de2a15b39f918d0f9c2/1c72d/dirty_room.jpg\"\n        srcset=\"/static/2cc395ed05f89de2a15b39f918d0f9c2/a80bd/dirty_room.jpg 148w,\n/static/2cc395ed05f89de2a15b39f918d0f9c2/1c91a/dirty_room.jpg 295w,\n/static/2cc395ed05f89de2a15b39f918d0f9c2/1c72d/dirty_room.jpg 590w,\n/static/2cc395ed05f89de2a15b39f918d0f9c2/b4294/dirty_room.jpg 600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>After compaction:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 290px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMCBAX/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB1lJJYlYT/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIDEQQSISIj/9oACAEBAAEFAnNSIOHAvLPZV85L2//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAECAQE/Aaf/xAAdEAABAwUBAAAAAAAAAAAAAAAAAhEyARASIVGR/9oACAEBAAY/At8tNhA+SvSVT//EABsQAQACAwEBAAAAAAAAAAAAAAEAESFBUYGx/9oACAEBAAE/IQ4mkFWKzPikYodxnBryNEfZ/9oADAMBAAIAAwAAABAs/wD/xAAWEQADAAAAAAAAAAAAAAAAAAAAESH/2gAIAQMBAT8QUZT/xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/EFsER//EABwQAQEBAAEFAAAAAAAAAAAAAAERACExQWFxwf/aAAgBAQABPxAAqRqcX3qykI6ecN9wtEwYgPKOKXFYsNNAkOAfTf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"clean room\"\n        title=\"clean room\"\n        src=\"/static/dfde7a215c69bda009ee179febecab21/baa30/clean_room.jpg\"\n        srcset=\"/static/dfde7a215c69bda009ee179febecab21/a80bd/clean_room.jpg 148w,\n/static/dfde7a215c69bda009ee179febecab21/baa30/clean_room.jpg 290w\"\n        sizes=\"(max-width: 290px) 100vw, 290px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>Without compaction, we would find there still has enough space but is not contiguous space so can't allocate the object.</p>\n<h4>Two finger compaction</h4>\n<p>Algorithm use by Lisp. The idea is using two pointers, one move from left to right(ideally) called free, one from right to left called scan, free stops while getting an empty chunk, scan stops while getting a non-empty chunk, when both stop, swap the chunk, end this process until they point to the same chunk, then we update all references.</p>\n<p>Cons: Only work with a fixed-size heap -> How to improve it?</p>\n<h4>Pinning Bits</h4>\n<p>When a pointer in C points to a reference from Ruby, and GC moved the object or delete it, what would happen? We can separate into different conditions:</p>\n<ul>\n<li>moved, in this condition, null reference caused exit</li>\n<li>delete, same as the previous one</li>\n<li>moved and move another object in, in this case, UB would happen, since you might treat an array object as a string object, the behavior is random, this is the craziest condition</li>\n</ul>\n<p>To avoid them, we have to tell GC what is hold by C pointer, so in C code not just allocate and free memory also have to write something like <code class=\"language-text\">gc_c_mark(pointer_to_ruby_object)</code> so GC know these objects must be pinned, it can't move them.</p>\n<h4>Allowing movement in C</h4>\n<p>Following things are related to how to allow movement in C</p>\n<ul>\n<li>\n<p>compaction callback</p>\n<p>  \tGC calls the C callback function after compaction is done, give C a chance to update its reference.</p>\n</li>\n<li>\n<p>No Pin marking</p>\n<p>  \tuse no pin function for reference object, so GC can manage the object.</p>\n</li>\n<li>\n<p>new location function</p>\n<p>  \t<code class=\"language-text\">rb_gc_location</code> would return the new location of the object.</p>\n</li>\n</ul>\n<h4>Known issue</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Ruby Object             C Object\n    |                      |\n    |                      |\n    \\---&gt; Third Object &lt;---/</code></pre></div>\n<p>Ruby automatically marked some object(gc<em>mark</em>no_pin), and not mark from C.</p>\n<p>So when compacter run, GC would move the Third Object however C still reference to old place so program explode.</p>\n<h4>Debugging GC</h4>\n<ol>\n<li>Maximum Chaos: doubling Heap</li>\n<li>Zombie Objects: let some slots can't be GC, always use a zombie object fill it</li>\n<li>Address Sanitizer: <a href=\"https://github.com/google/sanitizers/wiki/AddressSanitizer\">https://github.com/google/sanitizers/wiki/AddressSanitizer</a></li>\n</ol>\n<h4>More information</h4>\n<ul>\n<li><a href=\"https://bugs.ruby-lang.org/issues/15626\">https://bugs.ruby-lang.org/issues/15626</a></li>\n<li><a href=\"https://www.ruby-forum.com/t/rb-gc-register-address-or-rb-gc-mark/219828/2\">https://www.ruby-forum.com/t/rb-gc-register-address-or-rb-gc-mark/219828/2</a></li>\n<li><a href=\"https://ruby-hacking-guide.github.io/gc.html\">https://ruby-hacking-guide.github.io/gc.html</a></li>\n</ul>\n<h3>Additional part</h3>\n<p>For the rest part I don't have enough knowledge to sort out or I didn't take a look or I'm lazy. Here are video links.</p>\n<ul>\n<li><a href=\"https://youtu.be/Drxa_DiLV3s\">Automatic Differentiation for Ruby</a></li>\n<li><a href=\"https://youtu.be/x6FrRQMF5tg\">Virtual Machines: their common parts and what makes them special</a></li>\n<li><a href=\"https://youtu.be/Dtn9Uudw4Mo\">The Journey to One Million</a></li>\n</ul>\n<h3>Conculsion</h3>\n<p>Yes, another Ruby conference I join though I didn't know Ruby :).</p>","frontmatter":{"title":"Notes: Ruby Conf Taiwan 2019"}}},"pageContext":{"slug":"/blog/cs/ruby-conf-taiwan-2019/"}}}