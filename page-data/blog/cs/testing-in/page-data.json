{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/cs/testing-in/","result":{"data":{"markdownRemark":{"html":"<p>Just list some testing way in Go.</p>\n<p>Basically we use <code>testing</code> this built-in lib to testing</p>\n<p>To start your first test with Go is an easy task.</p>\n<p>Example(we would test the following function under directory <code>add</code>)</p>\n<pre><code class=\"language-go\">package add\n\nfunc Add(x, y int) int { return x + y }\n</code></pre>\n<ol>\n<li>create a file contains suffix <code>_test</code>, it would be a test file, e.g. <code>add_test.go</code></li>\n<li>\n<p>create a function in test file has prefix <code>Test</code>, use <code>t *testing.T</code> as it's parameter</p>\n<pre><code class=\"language-go\">package add\n\nimport \"testing\"\nfunc TestAdd(t *testing.T) {\n    if Add(1, 2) != 3 {\n        t.Errorf(\"Add(1, 2) should be 3 but: %d\", Add(1, 2))\n    }\n}\n</code></pre>\n</li>\n<li>type <code>go test</code> &#x26; execute it in terminal</li>\n</ol>\n<p>Ok, now we got a test, if you see the error message then must something wrong about your implementation of <code>Add</code></p>\n<blockquote>\n<p>p.s. Usually we won't use <code>go test</code> but <code>go test ./...</code> because we would have a lots of package under a project, <code>./...</code> would find out every sub directory(those can be a go package) &#x26; run test</p>\n</blockquote>\n<p>We have <code>func (*testing.T) Run(subTestName string, subTest func(t *testing.T))</code> this function, we can use it to create a new sub test.</p>\n<pre><code class=\"language-go\">func TestCarFactory(t *testing.T) {\n    factory := car.NewFactory()\n    t.Run(\"Toyota\", func(t *testing.T) {\n        toyota := factory.Build(car.Toyota)\n        // test toyota\n    })\n    t.Run(\"Mazda\", func(t *testing.T) {\n        mazda := factory.Build(car.Mazda)\n        // test mazda\n    })\n}\n</code></pre>\n<p>Basically you can see sub test means we want to reuse same context for different tests,\nor like me, just use it represents the test structure.</p>\n<p>A practical problem is sometime we extract a test helper out of the test function.</p>\n<p>For example:</p>\n<pre><code class=\"language-go\">func assertNoError(t *testing.T, err error) {\n    if err != nil {\n        t.Errorf(\"assert no error but: %s\", err)\n    }\n}\n</code></pre>\n<p>You will find all error say it happened at <code>t.Errorf</code> that line, but not the error actual happened place!</p>\n<p>To solve this problem, you have to add <code>t.Helper()</code> this function call, according document:</p>\n<blockquote>\n<p>Helper marks the calling function as a test helper function. When printing file and line information, that function will be skipped. Helper may be called simultaneously from multiple goroutines.</p>\n</blockquote>\n<p>I recommend <a href=\"https://github.com/stretchr/testify\">https://github.com/stretchr/testify</a> for assertion, <strong>Don't Reinvent The Wheel!</strong>(Some thing I always violate it)</p>\n<p>And <a href=\"https://github.com/gavv/httpexpect\">https://github.com/gavv/httpexpect</a> is an awesome lib for web API testing.</p>\n<p>A nice fact is, Go also help you create benchmark easy.</p>\n<p>Still in test file, but use <code>Benchmark</code> as prefix of test.</p>\n<pre><code class=\"language-go\">func BenchmarkAdd(b *testing.B) {\n    for i := 0; i &#x3C; b.N; i++ {\n        Add(1, 2)\n    }\n}\n</code></pre>\n<p>To run benchmark needs argument <code>-bench</code>, it would like <code>go test -bench .</code></p>\n<p>Output:</p>\n<pre><code>goos: darwin\ngoarch: amd64\npkg: test\nBenchmarkAdd-4          2000000000               0.61 ns/op\nPASS\nok      test    1.285s\n</code></pre>\n<p>As <code>t.Run</code>, you can have <code>b.Run</code> in benchmark.</p>\n<p>To get the nice analysis of program, you can use <code>go test -bench . -cpuprofile cpu.out -memprofile mem.out</code> to generate some profiles</p>\n<p>Then use <code>go tool pprof -http=127.0.0.1:5000 cpu.out</code> to see the result on browser(if you are familiar with CLI mode, you can remove <code>-http</code> flag)</p>\n<p>You can see something like:</p>\n<pre><code>----------------------------------------------------------+-------------\n                                            1130ms   100% |   testing.(*B).launch /usr/local/Cellar/go/1.11.2/libexec/src/testing/benchmark.go:290\n         0     0%   100%     1130ms 98.26%                | testing.(*B).runN /usr/local/Cellar/go/1.11.2/libexec/src/testing/benchmark.go:141\n                                            1130ms   100% |   test.BenchmarkAdd /Users/dannypsnl/code/go/src/test/add_test.go:8\n----------------------------------------------------------+-------------\n</code></pre>\n<p>At here example is too easy so nothing to show, in a real world code it would be pretty useful to know the hot point of the program.</p>\n<blockquote>\n<p>p.s. At profile example, <code>-bench</code> can't be omit, because we want something run a lots of time to detect it's real performance.</p>\n</blockquote>\n<p>If you want to get the performance under real usage, you can import pprof into program:</p>\n<pre><code class=\"language-go\">import (\n    _ \"net/http/pprof\"\n)\n</code></pre>\n<p>If your program is not a HTTP server, then you have to start one like:</p>\n<pre><code class=\"language-go\">go func() {\n    log.Println(http.ListenAndServe(\"0.0.0.0:6060\", nil))\n}()\n</code></pre>\n<p>The reason of <code>0.0.0.0</code> can reference to <a href=\"https://stackoverflow.com/questions/20778771/what-is-the-difference-between-0-0-0-0-127-0-0-1-and-localhost\">https://stackoverflow.com/questions/20778771/what-is-the-difference-between-0-0-0-0-127-0-0-1-and-localhost</a></p>\n<p>After these, you can run your program up then see your profile like <code>go tool pprof http://127.0.0.1:6060/debug/pprof/profile</code></p>\n<p>To get more info, you can reference:</p>\n<ul>\n<li><a href=\"https://golang.org/pkg/testing\">https://golang.org/pkg/testing</a></li>\n<li><a href=\"https://golang.org/pkg/net/http/pprof\">https://golang.org/pkg/net/http/pprof</a></li>\n</ul>\n<p>Thanks for reading</p>","frontmatter":{"title":"Testing in Go"}}},"pageContext":{"slug":"/blog/cs/testing-in/"}}}