{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/cs/note-get-labels-from/","result":{"data":{"markdownRemark":{"html":"<p>This week our company wants to improve one of our projects which is based on Istio, exchanging weight in different checker instances, make the traffic distribution fairer. My co-worker provides a nice idea: We watching Pods by the <a href=\"https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/\">label selector</a> to discover others instance. Code looks like:</p>\n<pre><code class=\"language-go\">watcher, err := client.CoreV1().Pods(\"istio-system\").Watch(meta.ListOptions{\n    Watch:         true,\n    LabelSelector: \"xxx=yyy\",\n})\n</code></pre>\n<p>But this causes a problem, you can see that string <code>\"xxx=yyy\"</code>, we have no graceful way to avoid the repeating of label selector in Kubernetes config(for Kubernetes) and environment variable(for our program). And one day they would outdated.</p>\n<p>In the beginning, we have a discussion and thought that it would unlikely to have the access to label selector value in Pod. Then start searching in the document. You know what? Surprisingly we can! Even have a few ways can choose! Let's take a look at them:</p>\n<ol>\n<li>\n<p>Use <code>env</code> variables</p>\n<pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: get-labels\nspec:\nselector:\n   matchLabels:\n   name: get-labels-container\ntemplate:\n   metadata:\n   labels:\n       name: get-labels-container\n   spec:\n   containers:\n       - name: a-container\n       image: ubuntu:18.04\n       env:\n           - name: SELECTOR_VALUE\n           valueFrom:\n               fieldRef:\n               fieldPath: metadata.labels['name']\n</code></pre>\n<p>In this case, we can get one value from a label selector pair.</p>\n</li>\n<li>\n<p>Load them into a file</p>\n<p>This requires a new API called: <code>downwardAPI</code></p>\n<pre><code class=\"language-yaml\">apiVersion: apps/v1\nkind: Deployment\nmetadata:\nname: get-labels\nspec:\nselector:\n   matchLabels:\n   name: get-labels-container\ntemplate:\n   metadata:\n   labels:\n       name: get-labels-container\n   spec:\n   containers:\n       - name: a-container\n       image: ubuntu:18.04\n       volumeMounts:\n           - name: podinfo\n           mountPath: /etc/podinfo\n       command:\n           - sleep\n           - inf\n   volumes:\n       - name: podinfo\n       downwardAPI:\n           items:\n           - path: \"labels\"\n               fieldRef:\n               fieldPath: metadata.labels\n</code></pre>\n<p>In this container, we can use <code>cat /etc/podinfo/labels</code> to get all label selectors. So if we want to get all of them then we can use this solution.</p>\n</li>\n</ol>\n<p>Now, hope this can save your time since it's in a weird place of Kubernetes document. And thanks for your read.</p>\n<h4>References</h4>\n<ul>\n<li><a href=\"https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/\">k8s Doc: Expose Pod Information to Containers Through Files</a></li>\n</ul>","frontmatter":{"title":"NOTE: get labels from Pod"}}},"pageContext":{"slug":"/blog/cs/note-get-labels-from/"}}}